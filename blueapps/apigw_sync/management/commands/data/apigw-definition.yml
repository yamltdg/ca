# 网关定义注册模板：
apigateway:
  description: "{{ settings.APP_CODE }} APIGW 网关"
  description_en: "{{ settings.APP_CODE }} APIGW"
  is_public: true
  # 标记网关为官方网关，网关名需以 `bk-` 开头，可选  官方选1，非官方选10
  api_type: 10
  # 网关所有者
  maintainers:
    {% for member in settings.APIGW_DEFINITION_SETTINGS.MAINTAINERS %}
    - "{{ member }}"
    {% endfor %}

# 资源发布
release:
  # 发布版本号，资源配置更新,每次部署都会自动发布
  version: {{ settings.APIGW_DEFINITION_SETTINGS.RELEASE_VERSION }}+{{ settings.APIGW_DEFINITION_SETTINGS.DEPLOY_DATETIME }}
  # 版本标题
  title: {{ settings.APIGW_DEFINITION_SETTINGS.RELEASE_VERSION }}+{{ settings.APIGW_DEFINITION_SETTINGS.DEPLOY_DATETIME }}
  # 版本描述
  comment: "auto release by blueapps apigw sync, time:{{ settings.APIGW_DEFINITION_SETTINGS.DEPLOY_DATETIME }}"

# 网关主动授权给应用，添加访问网关所有资源的权限
grant_permissions:
  {% for bk_app_code in settings.APIGW_DEFINITION_SETTINGS.BK_APIGW_GRANT_APPS %}
  - bk_app_code: "{{ bk_app_code }}"
  {% endfor %}

# 应用申请指定网关所有资源的权限，待网关管理员审批后，应用才可访问网关资源
apply_permissions:
  {% for api_name in settings.APIGW_DEFINITION_SETTINGS.BK_APIGW_APPLY_API_NAME %}
  - api_name: "{{ api_name }}"
  {% endfor %}

# 生产环境管理
stage:
  {% if settings.ENVIRONMENT == 'prod' %}
  name: "prod"
  description: "生产环境"
  description_en: "auto generate stage by blueapps"
  {% elif settings.ENVIRONMENT == 'stag' %}
  name: "stag"
  description: "预发布环境"
  description_en: "auto generate stage by blueapps"
  {% elif settings.ENVIRONMENT == 'dev' %}
  name: "dev"
  description: "开发环境"
  description_en: "auto generate stage by blueapps"
  {% endif %}
  # 代理配置
  proxy_http:
    # 网关调用后端服务的默认超时时间
    timeout: 60
    upstreams:
      # 负载均衡类型
      loadbalance: "roundrobin"
      hosts:
          # 网关调用后端服务的默认域名或IP
        {% if settings.ENVIRONMENT == 'prod' %}
        - host: "{{ settings.APIGW_DEFINITION_SETTINGS.BK_APIGW_API_PROD_HOST }}"
        {% elif settings.ENVIRONMENT == 'stag' %}
        - host: "{{ settings.APIGW_DEFINITION_SETTINGS.BK_APIGW_API_STAG_HOST }}"
        {% elif settings.ENVIRONMENT == 'dev' %}
        - host: "{{ settings.APIGW_DEFINITION_SETTINGS.BK_APIGW_API_STAG_HOST }}"
        {% endif %}
          weight: 100
  # 流量控制
  rate_limit:
    enabled: false
    rate:
      tokens: 5000
      period: 60
